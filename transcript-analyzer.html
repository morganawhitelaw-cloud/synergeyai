<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcript Analyzer - Project Dashboard</title>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #ffe600;
            --text: #e0e0e0;
            --text-muted: #888;
            --bg-card: #232946;
            --bg-hover: #2d3561;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #60a5fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: var(--text);
        }
        
        .header {
            background: rgba(26, 26, 46, 0.95);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--accent);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logo-dropdown {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-dropdown select {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            padding-right: 2.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffe600' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            transition: all 0.2s ease;
        }
        
        .logo-dropdown select:hover {
            background-color: var(--bg-hover);
            box-shadow: 0 0 12px rgba(255, 230, 0, 0.3);
        }
        
        .logo-dropdown select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 230, 0, 0.2);
        }
        
        .logo-dropdown select option {
            background: var(--bg-card);
            color: var(--accent);
            padding: 0.75rem;
            font-weight: 600;
        }
        
        .page-title {
            font-size: 1.25rem;
            color: var(--text);
            font-weight: 400;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-muted);
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }
        
        .nav-tab:hover {
            color: var(--text);
            background: var(--bg-hover);
        }
        
        .nav-tab.active {
            background: var(--accent);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .intro-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent);
        }
        
        .intro-section h2 {
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        
        .intro-section p {
            color: var(--text-muted);
        }
        
        .api-key-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .api-key-section h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .api-key-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .api-key-row input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--bg-hover);
            background: var(--primary);
            color: var(--text);
            font-family: monospace;
        }
        
        .api-key-row input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .api-key-status {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .api-key-status.valid {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }
        
        .api-key-status.invalid {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger);
        }
        
        .transcript-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .input-panel, .context-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .panel-header h3 {
            color: var(--accent);
        }
        
        .file-upload {
            display: flex;
            gap: 0.5rem;
        }
        
        .file-upload label {
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        
        .file-upload label:hover {
            background: var(--accent);
            color: var(--primary);
        }
        
        .file-upload input {
            display: none;
        }
        
        .transcript-input {
            width: 100%;
            height: 400px;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--bg-hover);
            background: var(--primary);
            color: var(--text);
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            resize: vertical;
            line-height: 1.6;
        }
        
        .transcript-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .transcript-input::placeholder {
            color: var(--text-muted);
        }
        
        .context-summary {
            background: var(--primary);
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--bg-hover);
        }
        
        .context-item:last-child {
            border-bottom: none;
        }
        
        .context-label {
            color: var(--text-muted);
        }
        
        .context-value {
            font-weight: 600;
            color: var(--accent);
        }
        
        .analyze-section {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .btn {
            padding: 1rem 2rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 230, 0, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background: var(--bg-card);
        }
        
        .btn-success {
            background: var(--success);
            color: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .token-usage {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .token-stats {
            display: flex;
            gap: 2rem;
        }
        
        .token-stat {
            text-align: center;
        }
        
        .token-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .token-stat .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .token-cost {
            font-size: 1.25rem;
            color: var(--success);
        }
        
        .results-section {
            display: none;
        }
        
        .results-section.visible {
            display: block;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .results-header h2 {
            color: var(--accent);
        }
        
        .results-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .category-section {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .category-header {
            padding: 1rem 1.5rem;
            background: var(--bg-hover);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-header:hover {
            background: var(--secondary);
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .category-title h3 {
            color: var(--text);
        }
        
        .category-badge {
            background: var(--accent);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .category-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .category-content {
            padding: 1rem 1.5rem;
            display: none;
        }
        
        .category-content.expanded {
            display: block;
        }
        
        .suggestion-card {
            background: var(--primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info);
            transition: all 0.2s;
        }
        
        .suggestion-card:last-child {
            margin-bottom: 0;
        }
        
        .suggestion-card.approved {
            border-left-color: var(--success);
            opacity: 0.7;
        }
        
        .suggestion-card.rejected {
            border-left-color: var(--danger);
            opacity: 0.5;
        }
        
        .suggestion-card.editing {
            border-left-color: var(--warning);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
        }
        
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .suggestion-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .suggestion-title {
            font-weight: 600;
            color: var(--text);
        }
        
        .suggestion-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .suggestion-body {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        
        .suggestion-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .meta-tag {
            background: var(--bg-hover);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .meta-tag.priority-high {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger);
        }
        
        .meta-tag.priority-medium {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }
        
        .meta-tag.priority-low {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }
        
        .suggestion-reasoning {
            background: var(--bg-hover);
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .suggestion-reasoning strong {
            color: var(--info);
        }
        
        .edit-form {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bg-hover);
        }
        
        .edit-form.visible {
            display: block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--bg-hover);
            background: var(--bg-card);
            color: var(--text);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .edit-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-overlay.visible {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-hover);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--text);
            font-size: 1.1rem;
        }
        
        .loading-subtext {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .apply-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            display: none;
        }
        
        .apply-section.visible {
            display: block;
        }
        
        .apply-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .apply-stats {
            display: flex;
            gap: 2rem;
        }
        
        .apply-stat {
            text-align: center;
        }
        
        .apply-stat .value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .apply-stat .value.approved {
            color: var(--success);
        }
        
        .apply-stat .value.rejected {
            color: var(--danger);
        }
        
        .apply-stat .value.pending {
            color: var(--warning);
        }
        
        .apply-stat .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        
        .chevron {
            transition: transform 0.2s;
        }
        
        .chevron.rotated {
            transform: rotate(180deg);
        }
        
        .history-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .history-section h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--primary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .history-date {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .history-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }
        
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: var(--success);
            color: var(--primary);
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .notification.visible {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.error {
            background: var(--danger);
            color: white;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo-dropdown">
                <select id="projectSelector" onchange="switchProject(this.value)">
                    <option value="">Loading projects...</option>
                </select>
            </div>
            <span class="page-title">/ Transcript Analyzer</span>
        </div>
        <nav class="nav-tabs">
            <a href="index.html" class="nav-tab">User Stories</a>
            <a href="sprint-planner.html" class="nav-tab">Sprint Timeline</a>
            <a href="progress-report.html" class="nav-tab">Progress Report</a>
            <a href="transcript-analyzer.html" class="nav-tab active">Transcript Analyzer</a>
            <a href="project-builder.html" class="nav-tab" style="background: rgba(255,230,0,0.15); border-color: var(--accent); color: var(--accent);">+ New Project</a>
        </nav>
    </header>
    
    <main class="main-content">
        <div class="intro-section">
            <h2>AI-Powered Transcript Analysis</h2>
            <p>Upload meeting transcripts from Zoom or Teams to automatically extract user stories, tasks, updates, and action items. Review and approve suggestions before they're added to your project.</p>
        </div>
        
        <div class="api-key-section">
            <h3>üîë OpenAI API Key</h3>
            <div class="api-key-row">
                <input type="password" id="apiKeyInput" placeholder="sk-..." oninput="validateApiKey()">
                <button class="btn btn-secondary btn-sm" onclick="toggleApiKeyVisibility()">Show</button>
                <span id="apiKeyStatus" class="api-key-status"></span>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem;">
                Your API key is stored locally in your browser and never sent to our servers. Get one at <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent);">platform.openai.com</a>
            </p>
        </div>
        
        <div class="transcript-section">
            <div class="input-panel">
                <div class="panel-header">
                    <h3>üìù Meeting Transcript</h3>
                    <div class="file-upload">
                        <label>
                            üìÅ Upload .txt/.vtt
                            <input type="file" id="fileInput" accept=".txt,.vtt" onchange="handleFileUpload(event)">
                        </label>
                        <button class="btn btn-secondary btn-sm" onclick="clearTranscript()">Clear</button>
                    </div>
                </div>
                <textarea id="transcriptInput" class="transcript-input" placeholder="Paste your Zoom or Teams meeting transcript here...

Example format:
00:00:15 John Smith: So for the next sprint, I think we need to prioritize the data validation feature.
00:00:32 Sarah Johnson: Agreed. We should also add error handling for the API endpoints.
00:01:05 John Smith: Good point. Let's also create a user story for the dashboard filtering.
..."></textarea>
                <div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-muted);">
                    <span id="charCount">0</span> characters | Supports Zoom VTT and Teams transcript formats
                </div>
            </div>
            
            <div class="context-panel">
                <div class="panel-header">
                    <h3>üìä Project Context</h3>
                    <button class="btn btn-secondary btn-sm" onclick="refreshContext()">Refresh</button>
                </div>
                <div class="context-summary" id="contextSummary">
                    <div class="empty-state">
                        <p>Select a project to see current state</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="analyze-section">
            <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeTranscript()" disabled>
                ü§ñ Analyze Transcript
            </button>
        </div>
        
        <div class="token-usage" id="tokenUsage" style="display: none;">
            <div class="token-stats">
                <div class="token-stat">
                    <div class="value" id="inputTokens">0</div>
                    <div class="label">Input Tokens</div>
                </div>
                <div class="token-stat">
                    <div class="value" id="outputTokens">0</div>
                    <div class="label">Output Tokens</div>
                </div>
                <div class="token-stat">
                    <div class="value" id="totalTokens">0</div>
                    <div class="label">Total Tokens</div>
                </div>
            </div>
            <div class="token-cost" id="tokenCost">
                Est. Cost: $0.00
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>üìã Suggested Changes</h2>
                <div class="results-actions">
                    <button class="btn btn-success btn-sm" onclick="approveAll()">‚úì Approve All</button>
                    <button class="btn btn-danger btn-sm" onclick="rejectAll()">‚úó Reject All</button>
                </div>
            </div>
            
            <div id="categoriesContainer">
                <!-- Categories will be populated by JavaScript -->
            </div>
            
            <div class="apply-section" id="applySection">
                <div class="apply-summary">
                    <div class="apply-stats">
                        <div class="apply-stat">
                            <div class="value approved" id="approvedCount">0</div>
                            <div class="label">Approved</div>
                        </div>
                        <div class="apply-stat">
                            <div class="value rejected" id="rejectedCount">0</div>
                            <div class="label">Rejected</div>
                        </div>
                        <div class="apply-stat">
                            <div class="value pending" id="pendingCount">0</div>
                            <div class="label">Pending</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="applyApprovedChanges()">
                        Apply Approved Changes
                    </button>
                </div>
            </div>
        </div>
        
        <div class="history-section" id="historySection">
            <h3>üìú Analysis History</h3>
            <div id="historyList">
                <div class="empty-state">
                    <p>No previous analyses for this project</p>
                </div>
            </div>
        </div>
    </main>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing transcript...</div>
            <div class="loading-subtext" id="loadingSubtext">This may take 30-60 seconds</div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Global state
        let currentProject = null;
        let projectData = null;
        let suggestions = [];
        let tokenUsageHistory = [];
        
        // Token pricing (GPT-4 Turbo pricing as of 2024)
        const TOKEN_PRICING = {
            input: 0.01 / 1000,   // $0.01 per 1K input tokens
            output: 0.03 / 1000   // $0.03 per 1K output tokens
        };
        
        // Category definitions
        const CATEGORIES = {
            'new_user_stories': { 
                title: 'New User Stories', 
                icon: 'üìñ',
                color: 'var(--info)'
            },
            'new_tasks': { 
                title: 'New Tasks', 
                icon: '‚úÖ',
                color: 'var(--success)'
            },
            'updates': { 
                title: 'Updates to Existing Items', 
                icon: '‚úèÔ∏è',
                color: 'var(--warning)'
            },
            'new_sprints': { 
                title: 'New Sprints', 
                icon: 'üèÉ',
                color: 'var(--accent)'
            },
            'risks': { 
                title: 'Risks & Blockers', 
                icon: '‚ö†Ô∏è',
                color: 'var(--danger)'
            }
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            await loadProjectList();
            loadApiKey();
            updateCharCount();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            document.getElementById('transcriptInput').addEventListener('input', () => {
                updateCharCount();
                updateAnalyzeButton();
            });
        }
        
        // Project management
        function getCurrentProject() {
            return localStorage.getItem('selectedProject') || null;
        }
        
        async function loadProjectList() {
            const selector = document.getElementById('projectSelector');
            try {
                const snapshot = await db.collection('projects').get();
                selector.innerHTML = '<option value="">Select Project...</option>';
                
                const savedProject = getCurrentProject();
                let foundSaved = false;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.config?.name || doc.id;
                    if (doc.id === savedProject) {
                        option.selected = true;
                        foundSaved = true;
                    }
                    selector.appendChild(option);
                });
                
                if (foundSaved) {
                    currentProject = savedProject;
                    await loadProjectContext();
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                selector.innerHTML = '<option value="">Error loading projects</option>';
            }
        }
        
        async function switchProject(projectId) {
            localStorage.setItem('selectedProject', projectId);
            currentProject = projectId;
            await loadProjectContext();
            loadAnalysisHistory();
            updateAnalyzeButton();
        }
        
        async function loadProjectContext() {
            const contextDiv = document.getElementById('contextSummary');
            
            if (!currentProject) {
                contextDiv.innerHTML = '<div class="empty-state"><p>Select a project to see current state</p></div>';
                projectData = null;
                return;
            }
            
            try {
                const doc = await db.collection('projects').doc(currentProject).get();
                
                if (!doc.exists) {
                    contextDiv.innerHTML = '<div class="empty-state"><p>Project not found</p></div>';
                    projectData = null;
                    return;
                }
                
                projectData = doc.data();
                const stories = projectData.userStories || [];
                const sprints = projectData.sprintData || [];
                const config = projectData.config || {};
                
                // Calculate stats
                const totalStories = stories.length;
                const completedStories = stories.filter(s => s.Status === 'Completed').length;
                const totalTasks = sprints.reduce((sum, s) => sum + (s.Tasks?.length || 0), 0);
                const completedTasks = sprints.reduce((sum, s) => 
                    sum + (s.Tasks?.filter(t => t.Status === 'Completed').length || 0), 0);
                const activeSprints = sprints.filter(s => s.Status === 'Active' || s.Status === 'In Progress').length;
                
                // Get unique epics
                const epics = [...new Set(stories.map(s => s.Epic).filter(e => e))];
                
                contextDiv.innerHTML = `
                    <div class="context-item">
                        <span class="context-label">Project Name</span>
                        <span class="context-value">${config.name || currentProject}</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Total Sprints</span>
                        <span class="context-value">${sprints.length}</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Active Sprints</span>
                        <span class="context-value">${activeSprints}</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">User Stories</span>
                        <span class="context-value">${completedStories}/${totalStories}</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Tasks</span>
                        <span class="context-value">${completedTasks}/${totalTasks}</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Epics</span>
                        <span class="context-value">${epics.length}</span>
                    </div>
                    <div class="context-item" style="flex-direction: column; align-items: flex-start;">
                        <span class="context-label">Epic List</span>
                        <span style="color: var(--text); font-size: 0.85rem; margin-top: 0.5rem;">
                            ${epics.length > 0 ? epics.map(e => `‚Ä¢ ${e}`).join('<br>') : 'No epics defined'}
                        </span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading project context:', error);
                contextDiv.innerHTML = '<div class="empty-state"><p>Error loading project data</p></div>';
            }
        }
        
        function refreshContext() {
            loadProjectContext();
            showNotification('Context refreshed');
        }
        
        // API Key management
        function loadApiKey() {
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
                validateApiKey();
            }
        }
        
        function validateApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const status = document.getElementById('apiKeyStatus');
            
            if (key.startsWith('sk-') && key.length > 20) {
                status.textContent = '‚úì Valid format';
                status.className = 'api-key-status valid';
                localStorage.setItem('openai_api_key', key);
            } else if (key.length > 0) {
                status.textContent = '‚úó Invalid format';
                status.className = 'api-key-status invalid';
            } else {
                status.textContent = '';
                status.className = 'api-key-status';
            }
            
            updateAnalyzeButton();
        }
        
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        }
        
        // Transcript handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                
                // Parse VTT format if needed
                if (file.name.endsWith('.vtt')) {
                    content = parseVTT(content);
                }
                
                document.getElementById('transcriptInput').value = content;
                updateCharCount();
                updateAnalyzeButton();
                showNotification(`Loaded: ${file.name}`);
            };
            reader.readAsText(file);
        }
        
        function parseVTT(vttContent) {
            // Remove VTT header and convert timestamps
            const lines = vttContent.split('\n');
            let result = [];
            let currentSpeaker = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Skip WEBVTT header and empty lines
                if (line === 'WEBVTT' || line === '' || line.match(/^\d+$/)) continue;
                
                // Check for timestamp line
                if (line.includes('-->')) {
                    const timestamp = line.split('-->')[0].trim().split('.')[0];
                    continue;
                }
                
                // Content line - check for speaker
                if (line.includes(':')) {
                    result.push(line);
                } else if (line.length > 0) {
                    result.push(line);
                }
            }
            
            return result.join('\n');
        }
        
        function clearTranscript() {
            document.getElementById('transcriptInput').value = '';
            updateCharCount();
            updateAnalyzeButton();
        }
        
        function updateCharCount() {
            const text = document.getElementById('transcriptInput').value;
            document.getElementById('charCount').textContent = text.length.toLocaleString();
        }
        
        function updateAnalyzeButton() {
            const hasTranscript = document.getElementById('transcriptInput').value.trim().length > 50;
            const hasApiKey = document.getElementById('apiKeyInput').value.startsWith('sk-');
            const hasProject = currentProject !== null;
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = !(hasTranscript && hasApiKey && hasProject);
            
            if (!hasProject) {
                btn.textContent = 'ü§ñ Select a Project First';
            } else if (!hasApiKey) {
                btn.textContent = 'ü§ñ Enter API Key First';
            } else if (!hasTranscript) {
                btn.textContent = 'ü§ñ Paste Transcript First';
            } else {
                btn.textContent = 'ü§ñ Analyze Transcript';
            }
        }
        
        // Main analysis function
        async function analyzeTranscript() {
            const transcript = document.getElementById('transcriptInput').value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!transcript || !apiKey || !projectData) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const prompt = buildAnalysisPrompt(transcript);
                const response = await callOpenAI(apiKey, prompt);
                
                if (response.error) {
                    throw new Error(response.error.message || 'API Error');
                }
                
                // Parse response
                const content = response.choices[0].message.content;
                suggestions = parseAISuggestions(content);
                
                // Update token usage
                updateTokenUsage(response.usage);
                
                // Render results
                renderSuggestions();
                
                // Save to history
                saveAnalysisToHistory(response.usage);
                
                showLoading(false);
                showNotification(`Found ${suggestions.length} suggestions`);
                
            } catch (error) {
                console.error('Analysis error:', error);
                showLoading(false);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        function buildAnalysisPrompt(transcript) {
            // Build context from project data
            const stories = projectData.userStories || [];
            const sprints = projectData.sprintData || [];
            const config = projectData.config || {};
            
            const existingStoriesText = stories.slice(0, 20).map(s => 
                `- [${s.Story_ID}] ${s.User_Story} (Epic: ${s.Epic}, Status: ${s.Status})`
            ).join('\n');
            
            const existingSprintsText = sprints.map(s => 
                `- Sprint ${s.Sprint}: ${s.Status} (${s.Tasks?.length || 0} tasks)`
            ).join('\n');
            
            const existingTasksText = sprints.flatMap(s => 
                (s.Tasks || []).slice(0, 5).map(t => `- [Sprint ${s.Sprint}] ${t.Task}: ${t.Status}`)
            ).slice(0, 30).join('\n');
            
            return `You are a product manager assistant analyzing a meeting transcript to extract actionable items for a software development project.

PROJECT CONTEXT:
Project Name: ${config.name || currentProject}
${config.purpose ? `Purpose: ${config.purpose}` : ''}

EXISTING USER STORIES:
${existingStoriesText || 'No user stories yet'}

EXISTING SPRINTS:
${existingSprintsText || 'No sprints yet'}

EXISTING TASKS:
${existingTasksText || 'No tasks yet'}

MEETING TRANSCRIPT:
${transcript}

INSTRUCTIONS:
Analyze the transcript and extract actionable items. For each item, determine:
1. Is this a NEW user story, task, or sprint that should be added?
2. Is this an UPDATE to an existing item (status change, scope change, new requirements)?
3. Is this a RISK or BLOCKER that should be tracked?

Be specific and actionable. Only suggest items that are clearly mentioned or implied in the transcript.

RESPOND IN THIS EXACT JSON FORMAT:
{
  "new_user_stories": [
    {
      "title": "Brief title",
      "user_story": "As a [user], I want [feature] so that [benefit]",
      "epic": "Suggested Epic name",
      "priority": "High/Medium/Low",
      "effort": 5,
      "reasoning": "Why this was extracted from the transcript"
    }
  ],
  "new_tasks": [
    {
      "title": "Task title",
      "description": "Task description",
      "sprint": 1,
      "assignee": "Mentioned person or 'Unassigned'",
      "estimated_hours": 8,
      "priority": "High/Medium/Low",
      "reasoning": "Why this was extracted"
    }
  ],
  "updates": [
    {
      "item_type": "story/task/sprint",
      "item_id": "ID of existing item to update",
      "changes": {
        "field_name": "new_value"
      },
      "reasoning": "Why this update is needed"
    }
  ],
  "new_sprints": [
    {
      "sprint_number": 5,
      "theme": "Sprint theme/focus",
      "start_date": "YYYY-MM-DD",
      "end_date": "YYYY-MM-DD",
      "reasoning": "Why a new sprint is needed"
    }
  ],
  "risks": [
    {
      "title": "Risk title",
      "description": "Risk description",
      "severity": "High/Medium/Low",
      "mitigation": "Suggested mitigation",
      "reasoning": "Why this is a risk"
    }
  ]
}

Only include categories that have items. If no items for a category, omit it entirely.`;
        }
        
        async function callOpenAI(apiKey, prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4-turbo-preview',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a product management assistant that extracts actionable items from meeting transcripts. Always respond with valid JSON.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.3,
                    max_tokens: 4000,
                    response_format: { type: 'json_object' }
                })
            });
            
            return await response.json();
        }
        
        function parseAISuggestions(content) {
            try {
                const parsed = JSON.parse(content);
                let allSuggestions = [];
                let id = 0;
                
                // Process each category
                for (const [category, items] of Object.entries(parsed)) {
                    if (Array.isArray(items) && CATEGORIES[category]) {
                        items.forEach(item => {
                            allSuggestions.push({
                                id: id++,
                                category: category,
                                status: 'pending', // pending, approved, rejected
                                data: item
                            });
                        });
                    }
                }
                
                return allSuggestions;
            } catch (error) {
                console.error('Error parsing AI response:', error);
                return [];
            }
        }
        
        function updateTokenUsage(usage) {
            document.getElementById('tokenUsage').style.display = 'flex';
            document.getElementById('inputTokens').textContent = usage.prompt_tokens.toLocaleString();
            document.getElementById('outputTokens').textContent = usage.completion_tokens.toLocaleString();
            document.getElementById('totalTokens').textContent = usage.total_tokens.toLocaleString();
            
            const cost = (usage.prompt_tokens * TOKEN_PRICING.input) + 
                        (usage.completion_tokens * TOKEN_PRICING.output);
            document.getElementById('tokenCost').textContent = `Est. Cost: $${cost.toFixed(4)}`;
        }
        
        // Render suggestions
        function renderSuggestions() {
            const container = document.getElementById('categoriesContainer');
            const resultsSection = document.getElementById('resultsSection');
            const applySection = document.getElementById('applySection');
            
            if (suggestions.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No suggestions found</h3><p>The AI didn\'t find any actionable items in the transcript.</p></div>';
                resultsSection.classList.add('visible');
                applySection.classList.remove('visible');
                return;
            }
            
            // Group by category
            const grouped = {};
            suggestions.forEach(s => {
                if (!grouped[s.category]) grouped[s.category] = [];
                grouped[s.category].push(s);
            });
            
            let html = '';
            for (const [category, items] of Object.entries(grouped)) {
                const catInfo = CATEGORIES[category];
                const pendingCount = items.filter(i => i.status === 'pending').length;
                const approvedCount = items.filter(i => i.status === 'approved').length;
                
                html += `
                    <div class="category-section" data-category="${category}">
                        <div class="category-header" onclick="toggleCategory('${category}')">
                            <div class="category-title">
                                <span>${catInfo.icon}</span>
                                <h3>${catInfo.title}</h3>
                                <span class="category-badge">${items.length}</span>
                            </div>
                            <div class="category-actions">
                                <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); approveCategory('${category}')">
                                    ‚úì Approve All (${pendingCount})
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); rejectCategory('${category}')">
                                    ‚úó Reject All
                                </button>
                                <span class="chevron">‚ñº</span>
                            </div>
                        </div>
                        <div class="category-content expanded" id="category-${category}">
                            ${items.map(item => renderSuggestionCard(item)).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            resultsSection.classList.add('visible');
            applySection.classList.add('visible');
            updateApplyCounts();
        }
        
        function renderSuggestionCard(suggestion) {
            const { id, category, status, data } = suggestion;
            const catInfo = CATEGORIES[category];
            
            let titleText = data.title || data.user_story || data.theme || 'Suggestion';
            let bodyText = '';
            let metaTags = '';
            
            switch (category) {
                case 'new_user_stories':
                    bodyText = data.user_story || '';
                    metaTags = `
                        <span class="meta-tag">Epic: ${data.epic || 'Unassigned'}</span>
                        <span class="meta-tag priority-${(data.priority || 'medium').toLowerCase()}">Priority: ${data.priority || 'Medium'}</span>
                        <span class="meta-tag">Effort: ${data.effort || 5} pts</span>
                    `;
                    break;
                case 'new_tasks':
                    bodyText = data.description || '';
                    metaTags = `
                        <span class="meta-tag">Sprint ${data.sprint || '?'}</span>
                        <span class="meta-tag">${data.estimated_hours || 8}h</span>
                        <span class="meta-tag priority-${(data.priority || 'medium').toLowerCase()}">${data.priority || 'Medium'}</span>
                        <span class="meta-tag">Assignee: ${data.assignee || 'Unassigned'}</span>
                    `;
                    break;
                case 'updates':
                    titleText = `Update ${data.item_type}: ${data.item_id}`;
                    bodyText = Object.entries(data.changes || {}).map(([k, v]) => `${k}: ${v}`).join(', ');
                    metaTags = `<span class="meta-tag">${data.item_type}</span>`;
                    break;
                case 'new_sprints':
                    titleText = `Sprint ${data.sprint_number}: ${data.theme}`;
                    bodyText = `${data.start_date} to ${data.end_date}`;
                    break;
                case 'risks':
                    bodyText = data.description || '';
                    metaTags = `
                        <span class="meta-tag priority-${(data.severity || 'medium').toLowerCase()}">Severity: ${data.severity || 'Medium'}</span>
                    `;
                    break;
            }
            
            return `
                <div class="suggestion-card ${status}" data-id="${id}">
                    <div class="suggestion-header">
                        <div>
                            <div class="suggestion-type">${catInfo.icon} ${catInfo.title.slice(0, -1)}</div>
                            <div class="suggestion-title">${titleText}</div>
                        </div>
                        <div class="suggestion-actions">
                            ${status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="approveSuggestion(${id})">‚úì</button>
                                <button class="btn btn-secondary btn-sm" onclick="editSuggestion(${id})">‚úé</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectSuggestion(${id})">‚úó</button>
                            ` : status === 'approved' ? `
                                <span style="color: var(--success);">‚úì Approved</span>
                                <button class="btn btn-secondary btn-sm" onclick="resetSuggestion(${id})">Undo</button>
                            ` : `
                                <span style="color: var(--danger);">‚úó Rejected</span>
                                <button class="btn btn-secondary btn-sm" onclick="resetSuggestion(${id})">Undo</button>
                            `}
                        </div>
                    </div>
                    ${bodyText ? `<div class="suggestion-body">${bodyText}</div>` : ''}
                    <div class="suggestion-meta">${metaTags}</div>
                    ${data.reasoning ? `
                        <div class="suggestion-reasoning">
                            <strong>AI Reasoning:</strong> ${data.reasoning}
                        </div>
                    ` : ''}
                    ${renderEditForm(suggestion)}
                </div>
            `;
        }
        
        function renderEditForm(suggestion) {
            const { id, category, data } = suggestion;
            
            let formFields = '';
            switch (category) {
                case 'new_user_stories':
                    formFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="edit-${id}-title" value="${escapeHtml(data.title || '')}">
                            </div>
                            <div class="form-group">
                                <label>Epic</label>
                                <input type="text" id="edit-${id}-epic" value="${escapeHtml(data.epic || '')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>User Story</label>
                            <textarea id="edit-${id}-user_story" rows="2">${escapeHtml(data.user_story || '')}</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="edit-${id}-priority">
                                    <option value="High" ${data.priority === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${data.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Effort (points)</label>
                                <input type="number" id="edit-${id}-effort" value="${data.effort || 5}" min="1" max="21">
                            </div>
                        </div>
                    `;
                    break;
                case 'new_tasks':
                    formFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="edit-${id}-title" value="${escapeHtml(data.title || '')}">
                            </div>
                            <div class="form-group">
                                <label>Sprint</label>
                                <input type="number" id="edit-${id}-sprint" value="${data.sprint || 1}" min="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="edit-${id}-description" rows="2">${escapeHtml(data.description || '')}</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Estimated Hours</label>
                                <input type="number" id="edit-${id}-estimated_hours" value="${data.estimated_hours || 8}" min="1">
                            </div>
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="edit-${id}-priority">
                                    <option value="High" ${data.priority === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${data.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Assignee</label>
                                <input type="text" id="edit-${id}-assignee" value="${escapeHtml(data.assignee || '')}">
                            </div>
                        </div>
                    `;
                    break;
                case 'risks':
                    formFields = `
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="edit-${id}-title" value="${escapeHtml(data.title || '')}">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="edit-${id}-description" rows="2">${escapeHtml(data.description || '')}</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Severity</label>
                                <select id="edit-${id}-severity">
                                    <option value="High" ${data.severity === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${data.severity === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${data.severity === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Mitigation</label>
                            <textarea id="edit-${id}-mitigation" rows="2">${escapeHtml(data.mitigation || '')}</textarea>
                        </div>
                    `;
                    break;
                default:
                    formFields = '<p>Editing not available for this item type</p>';
            }
            
            return `
                <div class="edit-form" id="edit-form-${id}">
                    ${formFields}
                    <div class="edit-actions">
                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit(${id})">Cancel</button>
                        <button class="btn btn-success btn-sm" onclick="saveEdit(${id})">Save & Approve</button>
                    </div>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Suggestion actions
        function approveSuggestion(id) {
            const suggestion = suggestions.find(s => s.id === id);
            if (suggestion) {
                suggestion.status = 'approved';
                renderSuggestions();
            }
        }
        
        function rejectSuggestion(id) {
            const suggestion = suggestions.find(s => s.id === id);
            if (suggestion) {
                suggestion.status = 'rejected';
                renderSuggestions();
            }
        }
        
        function resetSuggestion(id) {
            const suggestion = suggestions.find(s => s.id === id);
            if (suggestion) {
                suggestion.status = 'pending';
                renderSuggestions();
            }
        }
        
        function editSuggestion(id) {
            const card = document.querySelector(`.suggestion-card[data-id="${id}"]`);
            const form = document.getElementById(`edit-form-${id}`);
            if (card && form) {
                card.classList.add('editing');
                form.classList.add('visible');
            }
        }
        
        function cancelEdit(id) {
            const card = document.querySelector(`.suggestion-card[data-id="${id}"]`);
            const form = document.getElementById(`edit-form-${id}`);
            if (card && form) {
                card.classList.remove('editing');
                form.classList.remove('visible');
            }
        }
        
        function saveEdit(id) {
            const suggestion = suggestions.find(s => s.id === id);
            if (!suggestion) return;
            
            // Collect edited values based on category
            const fields = ['title', 'epic', 'user_story', 'priority', 'effort', 'description', 
                          'sprint', 'estimated_hours', 'assignee', 'severity', 'mitigation'];
            
            fields.forEach(field => {
                const input = document.getElementById(`edit-${id}-${field}`);
                if (input) {
                    suggestion.data[field] = input.type === 'number' ? parseInt(input.value) : input.value;
                }
            });
            
            suggestion.status = 'approved';
            renderSuggestions();
            showNotification('Changes saved and approved');
        }
        
        // Category actions
        function toggleCategory(category) {
            const content = document.getElementById(`category-${category}`);
            const header = content.previousElementSibling;
            const chevron = header.querySelector('.chevron');
            
            content.classList.toggle('expanded');
            chevron.classList.toggle('rotated');
        }
        
        function approveCategory(category) {
            suggestions.filter(s => s.category === category && s.status === 'pending')
                      .forEach(s => s.status = 'approved');
            renderSuggestions();
            showNotification(`Approved all ${CATEGORIES[category].title.toLowerCase()}`);
        }
        
        function rejectCategory(category) {
            suggestions.filter(s => s.category === category && s.status !== 'rejected')
                      .forEach(s => s.status = 'rejected');
            renderSuggestions();
            showNotification(`Rejected all ${CATEGORIES[category].title.toLowerCase()}`);
        }
        
        function approveAll() {
            suggestions.filter(s => s.status === 'pending').forEach(s => s.status = 'approved');
            renderSuggestions();
            showNotification('Approved all suggestions');
        }
        
        function rejectAll() {
            suggestions.forEach(s => s.status = 'rejected');
            renderSuggestions();
            showNotification('Rejected all suggestions');
        }
        
        function updateApplyCounts() {
            const approved = suggestions.filter(s => s.status === 'approved').length;
            const rejected = suggestions.filter(s => s.status === 'rejected').length;
            const pending = suggestions.filter(s => s.status === 'pending').length;
            
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('rejectedCount').textContent = rejected;
            document.getElementById('pendingCount').textContent = pending;
        }
        
        // Apply changes to Firebase
        async function applyApprovedChanges() {
            const approved = suggestions.filter(s => s.status === 'approved');
            
            if (approved.length === 0) {
                showNotification('No approved changes to apply', 'error');
                return;
            }
            
            showLoading(true, 'Applying changes to project...');
            
            try {
                // Get current project data
                const doc = await db.collection('projects').doc(currentProject).get();
                const data = doc.data() || {};
                
                let userStories = data.userStories || [];
                let sprintData = data.sprintData || [];
                
                // Process each approved suggestion
                for (const suggestion of approved) {
                    switch (suggestion.category) {
                        case 'new_user_stories':
                            const newStoryId = `US-${String(userStories.length + 1).padStart(3, '0')}`;
                            userStories.push({
                                Story_ID: newStoryId,
                                User_Story: suggestion.data.user_story || suggestion.data.title,
                                Epic: suggestion.data.epic || 'Unassigned',
                                Priority: suggestion.data.priority || 'Medium',
                                Effort_Required: suggestion.data.effort || 5,
                                Status: 'Yet to start',
                                Acceptance_Criteria: '',
                                Sprint: null,
                                Added_From: 'Transcript Analysis'
                            });
                            break;
                            
                        case 'new_tasks':
                            const sprintNum = suggestion.data.sprint || 1;
                            let sprint = sprintData.find(s => s.Sprint === sprintNum);
                            
                            if (!sprint) {
                                // Create new sprint if doesn't exist
                                sprint = {
                                    Sprint: sprintNum,
                                    Status: 'Planned',
                                    Tasks: []
                                };
                                sprintData.push(sprint);
                            }
                            
                            if (!sprint.Tasks) sprint.Tasks = [];
                            
                            sprint.Tasks.push({
                                Task: suggestion.data.title,
                                Description: suggestion.data.description || '',
                                Status: 'Not Started',
                                Estimated_Hours: suggestion.data.estimated_hours || 8,
                                Assignee: suggestion.data.assignee || 'Unassigned',
                                Priority: suggestion.data.priority || 'Medium',
                                Added_From: 'Transcript Analysis'
                            });
                            break;
                            
                        case 'updates':
                            // Handle updates to existing items
                            if (suggestion.data.item_type === 'story') {
                                const story = userStories.find(s => s.Story_ID === suggestion.data.item_id);
                                if (story && suggestion.data.changes) {
                                    Object.assign(story, suggestion.data.changes);
                                }
                            } else if (suggestion.data.item_type === 'task') {
                                for (const sprint of sprintData) {
                                    const task = sprint.Tasks?.find(t => t.Task === suggestion.data.item_id);
                                    if (task && suggestion.data.changes) {
                                        Object.assign(task, suggestion.data.changes);
                                        break;
                                    }
                                }
                            }
                            break;
                            
                        case 'new_sprints':
                            const existingSprint = sprintData.find(s => s.Sprint === suggestion.data.sprint_number);
                            if (!existingSprint) {
                                sprintData.push({
                                    Sprint: suggestion.data.sprint_number,
                                    Theme: suggestion.data.theme,
                                    Start_Date: suggestion.data.start_date,
                                    End_Date: suggestion.data.end_date,
                                    Status: 'Planned',
                                    Tasks: [],
                                    Added_From: 'Transcript Analysis'
                                });
                            }
                            break;
                            
                        case 'risks':
                            // Add risks as high-priority tasks or notes
                            const riskSprint = sprintData[0] || { Sprint: 1, Tasks: [], Status: 'Active' };
                            if (!riskSprint.Tasks) riskSprint.Tasks = [];
                            
                            riskSprint.Tasks.push({
                                Task: `[RISK] ${suggestion.data.title}`,
                                Description: `${suggestion.data.description}\n\nMitigation: ${suggestion.data.mitigation || 'TBD'}`,
                                Status: 'Not Started',
                                Priority: suggestion.data.severity || 'High',
                                Type: 'Risk',
                                Added_From: 'Transcript Analysis'
                            });
                            
                            if (!sprintData.includes(riskSprint)) {
                                sprintData.push(riskSprint);
                            }
                            break;
                    }
                }
                
                // Sort sprints by number
                sprintData.sort((a, b) => a.Sprint - b.Sprint);
                
                // Save to Firebase
                await db.collection('projects').doc(currentProject).update({
                    userStories: userStories,
                    sprintData: sprintData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear applied suggestions
                suggestions = suggestions.filter(s => s.status !== 'approved');
                renderSuggestions();
                
                showLoading(false);
                showNotification(`Applied ${approved.length} changes successfully!`);
                
                // Refresh context
                await loadProjectContext();
                
            } catch (error) {
                console.error('Error applying changes:', error);
                showLoading(false);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }
        
        // History management
        function saveAnalysisToHistory(usage) {
            const history = JSON.parse(localStorage.getItem(`analysis_history_${currentProject}`) || '[]');
            
            history.unshift({
                date: new Date().toISOString(),
                suggestions: suggestions.length,
                tokens: usage.total_tokens,
                cost: (usage.prompt_tokens * TOKEN_PRICING.input) + (usage.completion_tokens * TOKEN_PRICING.output)
            });
            
            // Keep only last 10
            if (history.length > 10) history.pop();
            
            localStorage.setItem(`analysis_history_${currentProject}`, JSON.stringify(history));
            loadAnalysisHistory();
        }
        
        function loadAnalysisHistory() {
            const historyList = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem(`analysis_history_${currentProject}`) || '[]');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="empty-state"><p>No previous analyses for this project</p></div>';
                return;
            }
            
            historyList.innerHTML = history.map(h => {
                const date = new Date(h.date);
                return `
                    <div class="history-item">
                        <span class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                        <div class="history-stats">
                            <span>${h.suggestions} suggestions</span>
                            <span>${h.tokens.toLocaleString()} tokens</span>
                            <span>$${h.cost.toFixed(4)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // UI helpers
        function showLoading(show, text = 'Analyzing transcript...') {
            const overlay = document.getElementById('loadingOverlay');
            document.querySelector('.loading-text').textContent = text;
            overlay.classList.toggle('visible', show);
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('visible');
            
            setTimeout(() => {
                notification.classList.remove('visible');
            }, 3000);
        }
    </script>
</body>
</html>
